<!-- Dashboard de Rendimiento -->
<div class="bg-dark text-white py-4 position-relative overflow-hidden">
  <div class="position-absolute top-0 start-0 w-100 h-100 opacity-10">
    <svg width="100%" height="100%" viewBox="0 0 800 800" xmlns="http://www.w3.org/2000/svg">
      <g fill="none" stroke="#4f46e5" stroke-width="2">
        <path d="M769 229L1037 260.9M927 880L731 737 520 660 309 538 40 599 295 764"></path>
        <path d="M320 340L40 599 380 737"></path>
        <path d="M520 660L309 538"></path>
        <path d="M520 660L295 764"></path>
      </g>
      <g fill="rgba(255,255,255,0.05)">
        <circle cx="769" cy="229" r="5"></circle>
        <circle cx="927" cy="880" r="5"></circle>
        <circle cx="40" cy="599" r="5"></circle>
        <circle cx="320" cy="340" r="5"></circle>
        <circle cx="380" cy="737" r="5"></circle>
      </g>
    </svg>
  </div>
  <div class="container position-relative">
    <div class="row align-items-center">
      <div class="col-lg-6">
        <h1 class="display-4 fw-bold mb-2">Dashboard de Rendimiento</h1>
        <p class="lead opacity-75 mb-0">Monitoreo en tiempo real de consultas a MongoDB</p>
      </div>
      <div class="col-lg-6 text-lg-end">
        <button id="benchmark-btn" class="btn btn-primary btn-lg mt-3 mt-lg-0">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20" class="me-2">
            <path d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z" />
          </svg>
          Ejecutar Benchmark
        </button>
      </div>
    </div>
  </div>
</div>

<div class="container py-5">
  <!-- Tarjetas de Resumen -->
  <div class="row mb-5">
    <div class="col-md-3 mb-4">
      <div class="card border-0 shadow-sm h-100 bg-gradient-primary text-white">
        <div class="card-body p-4">
          <div class="d-flex align-items-center mb-3">
            <div class="icon-box rounded-circle bg-primary-subtle p-3 me-3">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24" class="text-primary">
                <path d="M5.625 1.5c-1.036 0-1.875.84-1.875 1.875v17.25c0 1.035.84 1.875 1.875 1.875h12.75c1.035 0 1.875-.84 1.875-1.875V12.75A3.75 3.75 0 0 0 16.5 9h-1.875a1.875 1.875 0 0 1-1.875-1.875V5.25A3.75 3.75 0 0 0 9 1.5H5.625Z" />
                <path d="M12.971 1.816A5.23 5.23 0 0 1 14.25 5.25v1.875c0 .207.168.375.375.375H16.5a5.23 5.23 0 0 1 3.434 1.279 9.768 9.768 0 0 0-6.963-6.963Z" />
              </svg>
            </div>
            <h5 class="card-title mb-0">Total de Consultas</h5>
          </div>
          <h2 class="display-5 mb-0 fw-bold"><%= stats.totalQueries %></h2>
          <div class="mt-3 small">
            <span class="opacity-75">Desde el inicio del servidor</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3 mb-4">
      <div class="card border-0 shadow-sm h-100 bg-gradient-success text-white">
        <div class="card-body p-4">
          <div class="d-flex align-items-center mb-3">
            <div class="icon-box rounded-circle bg-success-subtle p-3 me-3">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24" class="text-success">
                <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z" />
              </svg>
            </div>
            <h5 class="card-title mb-0">Tiempo Promedio</h5>
          </div>
          <h2 class="display-5 mb-0 fw-bold"><%= stats.avgTime ? stats.avgTime.toFixed(2) : 0 %> ms</h2>
          <div class="mt-3 small">
            <span class="opacity-75">Promedio de todas las consultas</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3 mb-4">
      <div class="card border-0 shadow-sm h-100 bg-gradient-warning text-white">
        <div class="card-body p-4">
          <div class="d-flex align-items-center mb-3">
            <div class="icon-box rounded-circle bg-warning-subtle p-3 me-3">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24" class="text-warning">
                <path fill-rule="evenodd" d="M2.25 13.5a8.25 8.25 0 0 1 8.25-8.25.75.75 0 0 1 .75.75v6.75H18a.75.75 0 0 1 .75.75 8.25 8.25 0 0 1-16.5 0Z" />
                <path fill-rule="evenodd" d="M12.75 3a.75.75 0 0 1 .75-.75 8.25 8.25 0 0 1 8.25 8.25.75.75 0 0 1-.75.75h-7.5a.75.75 0 0 1-.75-.75V3Z" />
              </svg>
            </div>
            <h5 class="card-title mb-0">Tiempo Máximo</h5>
          </div>
          <h2 class="display-5 mb-0 fw-bold"><%= stats.maxTime.toFixed(2) %> ms</h2>
          <div class="mt-3 small">
            <span class="opacity-75">Consulta más lenta</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3 mb-4">
      <div class="card border-0 shadow-sm h-100 bg-gradient-info text-white">
        <div class="card-body p-4">
          <div class="d-flex align-items-center mb-3">
            <div class="icon-box rounded-circle bg-info-subtle p-3 me-3">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24" class="text-info">
                <path fill-rule="evenodd" d="M1.5 5.625c0-1.036.84-1.875 1.875-1.875h17.25c1.035 0 1.875.84 1.875 1.875v12.75c0 1.035-.84 1.875-1.875 1.875H3.375A1.875 1.875 0 0 1 1.5 18.375V5.625ZM21 9.375A.375.375 0 0 0 20.625 9h-7.5a.375.375 0 0 0-.375.375v1.5c0 .207.168.375.375.375h7.5a.375.375 0 0 0 .375-.375v-1.5Zm0 3.75a.375.375 0 0 0-.375-.375h-7.5a.375.375 0 0 0-.375.375v1.5c0 .207.168.375.375.375h7.5a.375.375 0 0 0 .375-.375v-1.5Zm0 3.75a.375.375 0 0 0-.375-.375h-7.5a.375.375 0 0 0-.375.375v1.5c0 .207.168.375.375.375h7.5a.375.375 0 0 0 .375-.375v-1.5ZM10.875 18.75a.375.375 0 0 0 .375-.375v-1.5a.375.375 0 0 0-.375-.375h-7.5a.375.375 0 0 0-.375.375v1.5c0 .207.168.375.375.375h7.5ZM3.375 15h7.5a.375.375 0 0 0 .375-.375v-1.5a.375.375 0 0 0-.375-.375h-7.5a.375.375 0 0 0-.375.375v1.5c0 .207.168.375.375.375Zm0-3.75h7.5a.375.375 0 0 0 .375-.375v-1.5A.375.375 0 0 0 10.875 9h-7.5A.375.375 0 0 0 3 9.375v1.5c0 .207.168.375.375.375Z" />
              </svg>
            </div>
            <h5 class="card-title mb-0">Total de Cursores</h5>
          </div>
          <h2 class="display-5 mb-0 fw-bold"><%= totalCursores %></h2>
          <div class="mt-3 small">
            <span class="opacity-75">Registros en la base de datos</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Gráficos y Tablas -->
  <div class="row">
    <!-- Gráfico de Tiempo de Consultas -->
    <div class="col-lg-8 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white py-3 border-0">
          <h5 class="mb-0 fw-bold">Tiempo de Consultas Recientes</h5>
        </div>
        <div class="card-body">
          <canvas id="queryTimeChart" height="250"></canvas>
        </div>
      </div>
    </div>
    
    <!-- Consultas por Operación -->
    <div class="col-lg-4 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white py-3 border-0">
          <h5 class="mb-0 fw-bold">Operaciones por Tipo</h5>
        </div>
        <div class="card-body">
          <canvas id="operationsChart" height="250"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Consultas recientes y Estado de la Base de Datos -->
  <div class="row">
    <!-- Últimas Consultas -->
    <div class="col-lg-8 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
          <h5 class="mb-0 fw-bold">Consultas Recientes</h5>
          <a href="/dashboard/queries" class="btn btn-sm btn-outline-primary">Ver Todas</a>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th scope="col">Operación</th>
                  <th scope="col">Colección</th>
                  <th scope="col">Tiempo (ms)</th>
                  <th scope="col">Hora</th>
                </tr>
              </thead>
              <tbody>
                <% if (stats.queries && stats.queries.length > 0) { %>
                  <% stats.queries.slice(-5).reverse().forEach(query => { %>
                    <tr>
                      <td><span class="badge bg-<%= query.operation === 'find' ? 'primary' : (query.operation === 'update' ? 'warning' : (query.operation === 'insert' ? 'success' : (query.operation === 'delete' ? 'danger' : 'secondary'))) %> rounded-pill"><%= query.operation %></span></td>
                      <td><%= query.collection %></td>
                      <td><%= query.time.toFixed(2) %> ms</td>
                      <td><%= new Date(query.timestamp).toLocaleTimeString() %></td>
                    </tr>
                  <% }); %>
                <% } else { %>
                  <tr>
                    <td colspan="4" class="text-center py-4">No hay consultas registradas todavía.</td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Estado de la BD -->
    <div class="col-lg-4 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white py-3 border-0">
          <h5 class="mb-0 fw-bold">Información de Conexión</h5>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-3 border-bottom">
              <span class="fw-medium">Base de Datos</span>
              <span class="text-primary fw-semibold"><%= dbStats.dbName || 'N/A' %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-3 border-bottom">
              <span class="fw-medium">Estado</span>
              <span class="badge rounded-pill <%= dbStats.connectionState === 'Conectado' ? 'bg-success' : 'bg-danger' %>"><%= dbStats.connectionState %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-3 border-bottom">
              <span class="fw-medium">Host</span>
              <span><%= dbStats.host || 'N/A' %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-3">
              <span class="fw-medium">Puerto</span>
              <span><%= dbStats.port || 'N/A' %></span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Resultados de Benchmark -->
  <div id="benchmark-results" class="card border-0 shadow-sm mb-4 d-none">
    <div class="card-header bg-white py-3 border-0">
      <h5 class="mb-0 fw-bold">Resultados del Benchmark</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-8">
          <canvas id="benchmarkChart" height="200"></canvas>
        </div>
        <div class="col-md-4">
          <div class="alert alert-info d-flex align-items-center" role="alert">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="flex-shrink-0 me-2" width="24" height="24">
              <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12ZM12 8.25a.75.75 0 0 1 .75.75v3.75a.75.75 0 0 1-1.5 0V9a.75.75 0 0 1 .75-.75Zm0 8.25a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" clip-rule="evenodd" />
            </svg>
            <div>
              <span id="benchmark-time">-</span>
            </div>
          </div>
          <div id="benchmark-details" class="mt-3">
            <!-- Aquí se insertarán los detalles del benchmark -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Explicación del Benchmark -->
<div class="container mb-5">
  <div class="card border-0 shadow-sm">
    <div class="card-header bg-white py-3 border-0">
      <h5 class="mb-0 fw-bold">¿Qué es el Benchmark?</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-lg-8">
          <p>El <strong>Benchmark</strong> es una herramienta que ejecuta varias consultas de prueba en la base de datos MongoDB para medir su rendimiento en tiempo real. Al ejecutar el benchmark se realizan las siguientes operaciones:</p>
          
          <ol class="mb-4">
            <li><strong>Consulta básica</strong>: Obtiene un número limitado de documentos sin ningún tipo de filtro u ordenamiento específico.</li>
            <li><strong>Consulta con ordenamiento</strong>: Recupera documentos ordenados por fecha de creación, lo que permite evaluar el rendimiento de las operaciones de ordenamiento.</li>
            <li><strong>Consulta con paginación</strong>: Utiliza las operaciones skip y limit para simular la paginación, midiendo el impacto en el rendimiento.</li>
            <li><strong>Conteo de documentos</strong>: Cuenta el número total de documentos en la colección, una operación frecuente en aplicaciones.</li>
            <li><strong>Agregación</strong>: Ejecuta una operación de agregación que agrupa documentos por ciudad, demostrando el rendimiento de las consultas analíticas.</li>
          </ol>
          
          <p>Los resultados del benchmark proporcionan información valiosa sobre cómo responde la base de datos bajo diferentes tipos de carga, ayudando a identificar posibles cuellos de botella y oportunidades de optimización.</p>
        </div>
        <div class="col-lg-4">
          <div class="alert alert-primary">
            <h6 class="fw-bold">Beneficios del Benchmark</h6>
            <ul class="mb-0">
              <li>Mide el tiempo de respuesta de diferentes tipos de consultas</li>
              <li>Compara rendimiento entre distintas operaciones</li>
              <li>Ayuda a detectar problemas de rendimiento</li>
              <li>Evalúa el impacto del volumen de datos</li>
              <li>Facilita la optimización de consultas</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts para los gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Datos para gráficos
  const chartData = JSON.parse('<%- JSON.stringify(chartData) %>');
  const operationsData = JSON.parse('<%- JSON.stringify(operationsData) %>');
  
  // Gráfico de tiempo de consultas
  const queryTimeCtx = document.getElementById('queryTimeChart').getContext('2d');
  new Chart(queryTimeCtx, {
    type: 'line',
    data: {
      labels: chartData.labels,
      datasets: [{
        label: 'Tiempo (ms)',
        data: chartData.times,
        fill: true,
        backgroundColor: 'rgba(79, 70, 229, 0.1)',
        borderColor: 'rgb(79, 70, 229)',
        tension: 0.3,
        pointBackgroundColor: 'rgb(79, 70, 229)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Tiempo (ms)'
          }
        }
      }
    }
  });
  
  // Operaciones por tipo
  const operationsCtx = document.getElementById('operationsChart').getContext('2d');
  new Chart(operationsCtx, {
    type: 'doughnut',
    data: {
      labels: operationsData.map(d => d.operation),
      datasets: [{
        data: operationsData.map(d => d.count),
        backgroundColor: [
          'rgb(79, 70, 229)', 
          'rgb(16, 185, 129)', 
          'rgb(245, 158, 11)', 
          'rgb(239, 68, 68)',  
          'rgb(107, 114, 128)' 
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
  
  // Gestionar benchmark
  const benchmarkBtn = document.getElementById('benchmark-btn');
  const benchmarkResults = document.getElementById('benchmark-results');
  const benchmarkTime = document.getElementById('benchmark-time');
  const benchmarkDetails = document.getElementById('benchmark-details');
  
  benchmarkBtn.addEventListener('click', async () => {
    benchmarkBtn.disabled = true;
    benchmarkBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Ejecutando...';
    
    try {
      const response = await fetch('/dashboard/benchmark', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      const data = await response.json();
      
      if (data.success) {
        benchmarkResults.classList.remove('d-none');
        benchmarkTime.textContent = `Tiempo total: ${data.tiempo} ms`;
        
        // Mostrar detalles
        let detailsHtml = '<ul class="list-group">';
        detailsHtml += `<li class="list-group-item d-flex justify-content-between"><span>Consulta básica</span><span class="badge bg-primary">${data.resultados.basica} registros</span></li>`;
        detailsHtml += `<li class="list-group-item d-flex justify-content-between"><span>Consulta ordenada</span><span class="badge bg-primary">${data.resultados.ordenada} registros</span></li>`;
        detailsHtml += `<li class="list-group-item d-flex justify-content-between"><span>Consulta paginada</span><span class="badge bg-primary">${data.resultados.paginada} registros</span></li>`;
        detailsHtml += `<li class="list-group-item d-flex justify-content-between"><span>Conteo total</span><span class="badge bg-primary">${data.resultados.conteo} registros</span></li>`;
        detailsHtml += `<li class="list-group-item d-flex justify-content-between"><span>Resultados de agregación</span><span class="badge bg-primary">${data.resultados.agregacion} ciudades</span></li>`;
        detailsHtml += '</ul>';
        
        benchmarkDetails.innerHTML = detailsHtml;
        
        // Crear gráfico de benchmark
        const benchmarkCtx = document.getElementById('benchmarkChart').getContext('2d');
        new Chart(benchmarkCtx, {
          type: 'bar',
          data: {
            labels: ['Benchmark Consultas'],
            datasets: [{
              label: 'Tiempo (ms)',
              data: [data.tiempo],
              backgroundColor: 'rgba(79, 70, 229, 0.7)',
              borderColor: 'rgb(79, 70, 229)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Tiempo (ms)'
                }
              }
            }
          }
        });
      } else {
        alert('Error al realizar el benchmark: ' + data.message);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error al realizar el benchmark');
    } finally {
      benchmarkBtn.disabled = false;
      benchmarkBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20" class="me-2"><path d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z" /></svg>Ejecutar Benchmark';
    }
  });
});
</script>

<!-- Agregar estilos adicionales -->
<style>
  .bg-gradient-primary {
    background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
  }
  .bg-gradient-success {
    background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
  }
  .bg-gradient-warning {
    background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
  }
  .bg-gradient-info {
    background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%);
  }
  .icon-box {
    width: 56px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .bg-primary-subtle {
    background-color: rgba(255, 255, 255, 0.2);
  }
  .bg-success-subtle {
    background-color: rgba(255, 255, 255, 0.2);
  }
  .bg-warning-subtle {
    background-color: rgba(255, 255, 255, 0.2);
  }
  .bg-info-subtle {
    background-color: rgba(255, 255, 255, 0.2);
  }
</style> 